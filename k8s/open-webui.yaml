# ============================================================
# Open WebUI Kubernetes Configuration
# ============================================================
# This file contains the ConfigMap, PVC, Deployment, and Service
# for Open WebUI on Kubernetes.
#
# Prerequisites:
# 1. Create namespace: kubectl create namespace open-webui
# 2. Create secrets: kubectl apply -f k8s/secrets.yaml
#    (or use kubectl create secret, see secrets.yaml for instructions)
# 3. Deploy PostgreSQL: kubectl apply -f k8s/postgres.yaml
# 4. Deploy supporting services: kubectl apply -f k8s/searxng.yaml k8s/playwright.yaml
#
# Apply this file:
# kubectl apply -f k8s/open-webui.yaml
# ============================================================

---
# ============================================================
# ConfigMap: Non-sensitive configuration
# ============================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: open-webui-config
  namespace: open-webui
data:
  # ------------------------------------------------------------
  # DEPLOYMENT
  # ------------------------------------------------------------
  ENV: "prod"

  # Use .env for config (not database). Set to "true" in production
  # to allow admin UI config changes to persist.
  ENABLE_PERSISTENT_CONFIG: "false"
  RESET_CONFIG_ON_START: "true"

  # Application name
  WEBUI_NAME: "soev.ai"

  # CORS origins (adjust for your domain)
  CORS_ALLOW_ORIGIN: "https://voorbeeld.soev.ai"

  # ------------------------------------------------------------
  # ADMIN BOOTSTRAP
  # ------------------------------------------------------------
  OPENWEBUI_ADMIN_EMAIL: "lex@gradient-ds.com"
  OPENWEBUI_ADMIN_NAME: "Lex"

  # ------------------------------------------------------------
  # LOCALE & BRANDING
  # ------------------------------------------------------------
  DEFAULT_LOCALE: "nl-NL"

  # ------------------------------------------------------------
  # AUTHENTICATION & ACCESS
  # ------------------------------------------------------------
  WEBUI_AUTH: "true"
  ENABLE_SIGNUP: "false"
  ENABLE_LOGIN_FORM: "true"
  ENABLE_INITIAL_ADMIN_SIGNUP: "true"
  DEFAULT_USER_ROLE: "user"
  ENABLE_OAUTH_SIGNUP: "false"
  ENABLE_PASSWORD_AUTH: "true"

  # ------------------------------------------------------------
  # LLM PROVIDERS
  # ------------------------------------------------------------
  ENABLE_OLLAMA_API: "false"
  OPENAI_API_BASE_URL: "https://router.huggingface.co/v1"
  MODEL_WHITELIST: "openai/gpt-oss-120b,"

  # ------------------------------------------------------------
  # DATABASE (PostgreSQL in K8s)
  # ------------------------------------------------------------
  DATABASE_TYPE: "postgresql"
  DATABASE_USER: "openwebui"
  DATABASE_HOST: "postgres"
  DATABASE_PORT: "5432"
  DATABASE_NAME: "openwebui"
  # DATABASE_URL is constructed in the deployment env section

  # ------------------------------------------------------------
  # VECTOR DATABASE (Weaviate - external or in-cluster)
  # ------------------------------------------------------------
  # Option 1: Use external Weaviate (comment out for ChromaDB default)
  # VECTOR_DB: "weaviate"
  # WEAVIATE_HTTP_HOST: "weaviate"
  # WEAVIATE_HTTP_PORT: "8080"
  # WEAVIATE_GRPC_PORT: "50051"

  # Option 2: Use default ChromaDB (no config needed)
  # The app will use ChromaDB stored in /app/backend/data

  # ------------------------------------------------------------
  # RAG EMBEDDINGS
  # ------------------------------------------------------------
  RAG_EMBEDDING_ENGINE: "openai"
  RAG_EMBEDDING_MODEL: "text-embedding-3-small"
  RAG_EMBEDDING_BATCH_SIZE: "100"
  RAG_TOP_K: "5"
  RAG_RELEVANCE_THRESHOLD: "0.0"
  CHUNK_SIZE: "1000"
  CHUNK_OVERLAP: "100"
  RAG_ALLOWED_FILE_EXTENSIONS: "pdf,txt,md,docx,csv,json"

  # Reranking
  RAG_RERANKING_ENGINE: ""
  # RAG_RERANKING_MODEL: "cross-encoder/ms-marco-MiniLM-L-6-v2"
  # RAG_EXTERNAL_RERANKER_URL: "http://reranker:8086/rerank"

  # ------------------------------------------------------------
  # WEB SEARCH & WEBPAGE ATTACHMENT
  # ------------------------------------------------------------
  ENABLE_WEB_SEARCH: "true"
  WEB_SEARCH_ENGINE: "searxng"
  WEB_SEARCH_RESULT_COUNT: "5"
  ENABLE_WEB_LOADER_SSL_VERIFICATION: "true"
  WEB_LOADER_ENGINE: "playwright"

  # SearXNG (in-cluster service)
  SEARXNG_QUERY_URL: "http://searxng:8080/search"

  # Playwright (in-cluster service)
  PLAYWRIGHT_WS_URL: "ws://playwright:3000"
  PLAYWRIGHT_TIMEOUT: "10000"

  # ------------------------------------------------------------
  # FEATURE FLAGS
  # ------------------------------------------------------------
  FEATURE_CHAT_CONTROLS: "False"
  FEATURE_CAPTURE: "False"
  FEATURE_ARTIFACTS: "False"
  FEATURE_PLAYGROUND: "False"
  FEATURE_CHAT_OVERVIEW: "False"
  FEATURE_NOTES_AI_CONTROLS: "False"
  FEATURE_VOICE: "False"
  FEATURE_CHANGELOG: "False"
  FEATURE_SYSTEM_PROMPT: "False"
  FEATURE_MODELS: "True"
  FEATURE_KNOWLEDGE: "True"
  FEATURE_PROMPTS: "True"
  FEATURE_TOOLS: "False"
  FEATURE_ADMIN_EVALUATIONS: "False"
  FEATURE_ADMIN_FUNCTIONS: "False"
  FEATURE_ADMIN_SETTINGS: "True"
  FEATURE_ADMIN_SETTINGS_TABS: "models,tools,interface,db"

  # ------------------------------------------------------------
  # NOTES FEATURE
  # ------------------------------------------------------------
  ENABLE_NOTES: "true"
  USER_PERMISSIONS_FEATURES_NOTES: "true"

  # ------------------------------------------------------------
  # KNOWLEDGE BASE (Workspace)
  # ------------------------------------------------------------
  USER_PERMISSIONS_WORKSPACE_KNOWLEDGE_ACCESS: "true"

  # ------------------------------------------------------------
  # CODE INTERPRETER / EXECUTION
  # ------------------------------------------------------------
  ENABLE_CODE_INTERPRETER: "false"
  CODE_INTERPRETER_ENGINE: ""
  ENABLE_CODE_EXECUTION: "false"
  CODE_EXECUTION_ENGINE: ""
  USER_PERMISSIONS_FEATURES_CODE_INTERPRETER: "false"

  # ------------------------------------------------------------
  # MCP / TOOL SERVERS
  # ------------------------------------------------------------
  ENABLE_DIRECT_CONNECTIONS: "false"
  USER_PERMISSIONS_FEATURES_DIRECT_TOOL_SERVERS: "false"

  # ------------------------------------------------------------
  # TEXT-TO-SPEECH (TTS)
  # ------------------------------------------------------------
  AUDIO_TTS_ENGINE: ""
  AUDIO_TTS_MODEL: ""
  AUDIO_TTS_VOICE: ""
  AUDIO_TTS_SPLIT_ON: ""
  USER_PERMISSIONS_CHAT_TTS: "false"

  # ------------------------------------------------------------
  # SPEECH-TO-TEXT (STT)
  # ------------------------------------------------------------
  AUDIO_STT_ENGINE: ""
  AUDIO_STT_MODEL: ""
  WHISPER_MODEL: ""
  USER_PERMISSIONS_CHAT_STT: "false"
  USER_PERMISSIONS_CHAT_CALL: "false"

  # ------------------------------------------------------------
  # WORKSPACE SETTINGS
  # ------------------------------------------------------------
  USER_PERMISSIONS_WORKSPACE_MODELS_ACCESS: "true"
  USER_PERMISSIONS_WORKSPACE_PROMPTS_ACCESS: "true"
  USER_PERMISSIONS_WORKSPACE_TOOLS_ACCESS: "false"

  # ------------------------------------------------------------
  # UI FEATURES
  # ------------------------------------------------------------
  ENABLE_FOLDERS: "true"
  USER_PERMISSIONS_FEATURES_FOLDERS: "true"
  ENABLE_CHANNELS: "false"
  USER_PERMISSIONS_FEATURES_CHANNELS: "false"
  ENABLE_COMMUNITY_SHARING: "false"
  ENABLE_MESSAGE_RATING: "true"
  ENABLE_USER_WEBHOOKS: "false"
  ENABLE_AUTOCOMPLETE_GENERATION: "false"
  ENABLE_FOLLOW_UP_GENERATION: "true"
  ENABLE_TITLE_GENERATION: "true"
  ENABLE_TAGS_GENERATION: "true"
  ENABLE_SEARCH_QUERY_GENERATION: "true"
  ENABLE_RETRIEVAL_QUERY_GENERATION: "true"

  # ------------------------------------------------------------
  # USER CHAT PERMISSIONS
  # ------------------------------------------------------------
  USER_PERMISSIONS_CHAT_CONTROLS: "false"
  USER_PERMISSIONS_CHAT_VALVES: "false"
  USER_PERMISSIONS_CHAT_SYSTEM_PROMPT: "true"
  USER_PERMISSIONS_CHAT_PARAMS: "false"
  USER_PERMISSIONS_CHAT_FILE_UPLOAD: "true"
  USER_PERMISSIONS_CHAT_DELETE: "true"
  USER_PERMISSIONS_CHAT_DELETE_MESSAGE: "true"
  USER_PERMISSIONS_CHAT_EDIT: "true"
  USER_PERMISSIONS_CHAT_SHARE: "true"
  USER_PERMISSIONS_CHAT_EXPORT: "true"
  USER_PERMISSIONS_CHAT_CONTINUE_RESPONSE: "true"
  USER_PERMISSIONS_CHAT_REGENERATE_RESPONSE: "true"
  USER_PERMISSIONS_CHAT_RATE_RESPONSE: "true"
  USER_PERMISSIONS_CHAT_MULTIPLE_MODELS: "true"
  USER_PERMISSIONS_CHAT_TEMPORARY: "true"
  USER_PERMISSIONS_FEATURES_WEB_SEARCH: "true"
  USER_PERMISSIONS_FEATURES_IMAGE_GENERATION: "false"
  USER_PERMISSIONS_FEATURES_API_KEYS: "false"

  # ------------------------------------------------------------
  # ADMIN SETTINGS
  # ------------------------------------------------------------
  ENABLE_ADMIN_EXPORT: "true"
  ENABLE_ADMIN_CHAT_ACCESS: "false"
  ENABLE_ADMIN_WORKSPACE_CONTENT_ACCESS: "true"
  BYPASS_ADMIN_ACCESS_CONTROL: "true"
  SHOW_ADMIN_DETAILS: "false"

  # ------------------------------------------------------------
  # EVALUATION / ARENA
  # ------------------------------------------------------------
  ENABLE_EVALUATION_ARENA_MODELS: "false"

  # ------------------------------------------------------------
  # API KEYS
  # ------------------------------------------------------------
  ENABLE_API_KEYS: "false"
  JWT_EXPIRES_IN: "4w"

  # ------------------------------------------------------------
  # IMAGE GENERATION
  # ------------------------------------------------------------
  ENABLE_IMAGE_GENERATION: "false"

  # ------------------------------------------------------------
  # CLOUD STORAGE
  # ------------------------------------------------------------
  ENABLE_GOOGLE_DRIVE_INTEGRATION: "false"
  ENABLE_ONEDRIVE_INTEGRATION: "false"

  # ------------------------------------------------------------
  # TELEMETRY (Privacy)
  # ------------------------------------------------------------
  SCARF_NO_ANALYTICS: "true"
  DO_NOT_TRACK: "true"
  ANONYMIZED_TELEMETRY: "false"

  # ------------------------------------------------------------
  # ADVANCED
  # ------------------------------------------------------------
  BYPASS_MODEL_ACCESS_CONTROL: "true"

---
# ============================================================
# PersistentVolumeClaim: Data storage
# ============================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: open-webui-pvc
  namespace: open-webui
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard-rwo
  resources:
    requests:
      storage: 10Gi

---
# ============================================================
# Deployment: Open WebUI application
# ============================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-webui
  namespace: open-webui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: open-webui
  template:
    metadata:
      labels:
        app: open-webui
    spec:
      containers:
      - name: open-webui
        image: ghcr.io/gradient-ds/open-webui:main
        imagePullPolicy: Always
        ports:
        - containerPort: 8080

        # Load all ConfigMap values as environment variables
        envFrom:
        - configMapRef:
            name: open-webui-config

        # Override/add sensitive values from Secret
        env:
        # Session encryption key
        - name: WEBUI_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: open-webui-secrets
              key: WEBUI_SECRET_KEY

        # Database password (used to construct DATABASE_URL)
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open-webui-secrets
              key: DATABASE_PASSWORD

        # Construct DATABASE_URL with password from secret
        - name: DATABASE_URL
          value: "postgresql://openwebui:$(DATABASE_PASSWORD)@postgres:5432/openwebui"

        # Admin bootstrap password
        - name: OPENWEBUI_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: open-webui-secrets
              key: OPENWEBUI_ADMIN_PASSWORD

        # LLM API key
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: open-webui-secrets
              key: OPENAI_API_KEY

        # RAG Embedding API key
        - name: RAG_OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: open-webui-secrets
              key: RAG_OPENAI_API_KEY

        volumeMounts:
        - name: data
          mountPath: /app/backend/data

        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "2Gi"
            cpu: "1000m"

        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10

        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5

        startupProbe:
          httpGet:
            path: /health
            port: 8080
          failureThreshold: 30
          periodSeconds: 10

      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: open-webui-pvc

---
# ============================================================
# Service: Internal cluster access
# ============================================================
apiVersion: v1
kind: Service
metadata:
  name: open-webui
  namespace: open-webui
spec:
  selector:
    app: open-webui
  ports:
  - port: 8080
    targetPort: 8080
