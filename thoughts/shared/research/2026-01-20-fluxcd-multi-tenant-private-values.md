---
date: 2026-01-20T12:00:00+01:00
researcher: Claude
git_commit: e662a9946c75500b14dc7ed0e3486f064556caa4
branch: main
repository: open-webui
topic: "FluxCD Multi-Tenant Deployment with Private Values and Shared Services"
tags: [research, helm, fluxcd, multi-tenancy, gitops, kubernetes]
status: complete
last_updated: 2026-01-20
last_updated_by: Claude
---

# Research: FluxCD Multi-Tenant Deployment with Private Values and Shared Services

**Date**: 2026-01-20T12:00:00+01:00
**Researcher**: Claude
**Git Commit**: e662a9946c75500b14dc7ed0e3486f064556caa4
**Branch**: main
**Repository**: open-webui

## Research Question

How to manage multi-tenant Open WebUI deployments with:
1. Public Helm charts (open source) + private customer-specific values
2. FluxCD integration for GitOps
3. Shared services (gradient-gateway, monitoring) across isolated tenant deployments
4. Centralized observability with tenant isolation

## Summary

**Recommended Architecture:**

1. **Keep the standard Helm chart in this open-source repo** (`helm/open-webui-stack/`)
2. **Create a private deployments repo** for customer-specific values with SOPS encryption
3. **Use FluxCD Kustomize overlays** with `configMapGenerator`/`secretGenerator` for values injection
4. **Deploy shared services in a dedicated namespace** with network policies for controlled access
5. **Use the existing LGTM observability stack** with `X-Scope-OrgID` for tenant isolation

This is the industry-standard pattern used by Bitnami, Datadog, GitLab, and others.

## Detailed Findings

### 1. Repository Structure Recommendation

**Current State (This Repo):**
```
helm/
├── flux/                      # FluxCD manifests
│   ├── base/open-webui/       # HelmRelease, source definitions
│   └── clusters/production/   # Cluster-specific kustomizations
├── open-webui-stack/          # Helm chart (keep public)
│   ├── Chart.yaml
│   ├── values.yaml            # Safe defaults
│   └── templates/
└── observability/             # LGTM stack values (shared)
```

**Recommended Private Repo (New):**
```
# github.com/Gradient-DS/deployments (PRIVATE)
deployments/
├── .sops.yaml                          # SOPS encryption config
├── flux-system/
│   └── gotk-sync.yaml                  # Point to this private repo
├── sources/
│   ├── open-webui-chart.yaml           # GitRepository pointing to public repo
│   └── kustomization.yaml
├── shared-services/                    # Shared infra (one instance)
│   ├── gateway/
│   ├── observability/
│   └── kustomization.yaml
├── customers/
│   ├── customer-a/
│   │   ├── values.yaml                 # Non-sensitive config
│   │   ├── secrets.yaml                # SOPS-encrypted
│   │   └── kustomization.yaml          # Kustomize overlay
│   ├── customer-b/
│   │   └── ...
│   └── soev-internal/
│       └── ...
└── base/
    ├── helmrelease.yaml                # Base HelmRelease template
    └── kustomization.yaml
```

### 2. FluxCD Pattern: Kustomize ConfigMap/Secret Generators

The key insight: FluxCD `HelmRelease.spec.valuesFrom` only references ConfigMaps/Secrets, not files directly from Git. Use Kustomize generators to create these.

**Base HelmRelease** (`base/helmrelease.yaml`):
```yaml
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: open-webui
spec:
  interval: 30m
  chart:
    spec:
      chart: ./helm/open-webui-stack
      sourceRef:
        kind: GitRepository
        name: open-webui-public        # Points to public repo
        namespace: flux-system
  valuesFrom:
    - kind: ConfigMap
      name: open-webui-values          # Generated by Kustomize
      valuesKey: values.yaml
    - kind: Secret
      name: open-webui-secrets         # Generated by Kustomize (SOPS-encrypted source)
      valuesKey: values.yaml
```

**Customer Overlay** (`customers/customer-a/kustomization.yaml`):
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: customer-a

resources:
  - ../../base

configMapGenerator:
  - name: open-webui-values
    files:
      - values.yaml=values.yaml
    options:
      labels:
        reconcile.fluxcd.io/watch: "Enabled"

secretGenerator:
  - name: open-webui-secrets
    files:
      - values.yaml=secrets.yaml      # SOPS-encrypted
    options:
      labels:
        reconcile.fluxcd.io/watch: "Enabled"

patches:
  - patch: |
      - op: replace
        path: /metadata/namespace
        value: customer-a
      - op: replace
        path: /spec/values/ingress/hosts/0/host
        value: customer-a.soev.ai
    target:
      kind: HelmRelease
      name: open-webui

configurations:
  - ../../kustomizeconfig.yaml
```

**Critical kustomizeconfig.yaml** (enables name reference updating):
```yaml
nameReference:
  - kind: ConfigMap
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease
  - kind: Secret
    version: v1
    fieldSpecs:
      - path: spec/valuesFrom/name
        kind: HelmRelease
```

### 3. SOPS Encryption Setup

**`.sops.yaml`** in private repo root:
```yaml
creation_rules:
  - path_regex: secrets\.yaml$
    age: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
    # Or use GCP KMS:
    # gcp_kms: projects/soev-ai-001/locations/global/keyRings/sops/cryptoKeys/sops-key
```

**FluxCD Kustomization with decryption:**
```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: customer-a
  namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: deployments-private
  path: ./customers/customer-a
  prune: true
  decryption:
    provider: sops
    secretRef:
      name: sops-age-key              # Contains AGE private key
```

### 4. Multi-Tenant Architecture with Shared Services

**Recommended Namespace Layout:**
```
┌─────────────────────────────────────────────────────────────────┐
│                     Kubernetes Cluster                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              shared-services namespace                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │Gradient GW   │  │SearXNG       │  │Crawl4AI      │  │   │
│  │  │(facade)      │  │(web search)  │  │(doc extract) │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│        ┌─────────────────────┼─────────────────────┐           │
│        │                     │                     │           │
│  ┌─────▼─────┐         ┌─────▼─────┐         ┌─────▼─────┐    │
│  │customer-a │         │customer-b │         │soev-int   │    │
│  │           │         │           │         │           │    │
│  │-open-webui│         │-open-webui│         │-open-webui│    │
│  │-postgres  │         │-postgres  │         │-postgres  │    │
│  │-weaviate  │         │-weaviate  │         │-weaviate  │    │
│  │-reranker  │         │-reranker  │         │-reranker  │    │
│  └───────────┘         └───────────┘         └───────────┘    │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              observability namespace                     │   │
│  │  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌───────┐         │   │
│  │  │Mimir│  │Loki │  │Tempo│  │Alloy│  │Grafana│         │   │
│  │  └─────┘  └─────┘  └─────┘  └─────┘  └───────┘         │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**Network Policy: Default Deny for Tenant Namespace:**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: customer-a
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
```

**Network Policy: Allow Same-Namespace + Shared Services:**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-and-shared
  namespace: customer-a
spec:
  podSelector: {}
  ingress:
    - from:
        - podSelector: {}                    # Same namespace
  egress:
    - to:
        - podSelector: {}                    # Same namespace
    - to:
        - namespaceSelector:
            matchLabels:
              purpose: shared-services       # Shared services namespace
      ports:
        - port: 8000                         # Gateway
        - port: 8080                         # SearXNG
        - port: 11235                        # Crawl4AI
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - port: 53
          protocol: UDP                      # DNS
```

### 5. Observability: Multi-Tenant with X-Scope-OrgID

Your existing observability setup already supports this via the LGTM stack.

**Per-Tenant OpenTelemetry Configuration** (in tenant values.yaml):
```yaml
openWebui:
  config:
    telemetry:
      otel:
        enabled: true
        endpoint: "http://alloy.observability.svc:4317"
        serviceName: "open-webui"
        tenantId: "customer-a"              # Sets X-Scope-OrgID
        resourceAttributes: "deployment.environment=production,tenant=customer-a"
```

**Open WebUI template** (already configured in `helm/open-webui-stack/templates/open-webui/deployment.yaml`):
```yaml
env:
  - name: OTEL_EXPORTER_OTLP_HEADERS
    value: "X-Scope-OrgID={{ .Values.openWebui.config.telemetry.otel.tenantId }}"
```

**Grafana Datasource per Tenant:**
```yaml
datasources:
  - name: Loki-CustomerA
    type: loki
    url: http://loki.observability.svc:3100
    jsonData:
      httpHeaderName1: X-Scope-OrgID
    secureJsonData:
      httpHeaderValue1: customer-a
```

### 6. Shared Gateway Service Configuration

Modify the Helm chart to optionally use external gateway instead of per-tenant:

**values.yaml addition:**
```yaml
gateway:
  # Deploy gateway in this release (default)
  enabled: true

  # OR use external shared gateway
  external:
    enabled: false
    url: "http://gradient-gateway.shared-services.svc:8000"
```

**Template conditional:**
```yaml
{{- if .Values.gateway.external.enabled }}
env:
  - name: CONTENT_EXTRACTION_API_URL
    value: {{ .Values.gateway.external.url }}/extract
  - name: RAG_RERANKING_API_URL
    value: {{ .Values.gateway.external.url }}/rerank
  - name: WEB_LOADER_API_URL
    value: {{ .Values.gateway.external.url }}/fetch
{{- else }}
env:
  - name: CONTENT_EXTRACTION_API_URL
    value: http://{{ include "open-webui-stack.fullname" . }}-gateway:{{ .Values.gateway.service.port }}/extract
# ... etc
{{- end }}
```

## Code References

- `helm/flux/base/open-webui/helmrelease.yaml:1-73` - Current FluxCD HelmRelease
- `helm/open-webui-stack/values.yaml:1-604` - Base Helm values (public)
- `helm/observability/README.md:1-91` - LGTM stack documentation
- `helm/flux/README.md:1-126` - FluxCD setup documentation

## Architecture Insights

1. **Industry Standard**: Separate repos for charts vs. deployment values is the norm (Bitnami, Datadog, GitLab all do this)

2. **FluxCD Specificity**: Unlike ArgoCD's direct `valueFiles` from Git, FluxCD requires ConfigMap/Secret intermediaries - hence Kustomize generators

3. **Multi-Tenancy Tradeoffs**:
   - Namespace isolation: Simpler, cost-effective, sufficient for most cases
   - vCluster: Consider if tenants need cluster-scoped resources (CRDs)
   - Separate clusters: Only for strict compliance (HIPAA, SOC2 level 2)

4. **Shared Services Pattern**: Gateway/search/extraction services are stateless and can safely be shared. Per-tenant: database, vector store, user data.

## Open Questions

1. **Tenant Onboarding Automation**: Consider creating a CLI or script to scaffold new tenant directories with proper encryption

2. **Secrets Rotation**: Plan for rotating SOPS keys and updating encrypted files

3. **Cost Allocation**: With shared observability, how to attribute costs per tenant?

4. **Gateway Rate Limiting**: Should shared gateway have per-tenant rate limits?

## Recommendations Summary

| Decision | Recommendation |
|----------|----------------|
| Chart location | Keep in this public repo (`helm/open-webui-stack/`) |
| Values location | New private repo (`Gradient-DS/deployments`) |
| Values injection | FluxCD + Kustomize configMapGenerator/secretGenerator |
| Secrets | SOPS with Age or GCP KMS |
| Tenant isolation | Namespace-based with NetworkPolicies |
| Shared services | Gateway, SearXNG, Crawl4AI in `shared-services` namespace |
| Per-tenant services | Open WebUI, PostgreSQL, Weaviate, Reranker |
| Observability | Shared LGTM stack with X-Scope-OrgID tenant headers |
